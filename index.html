<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smooth Audio Echo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .visualizer-wrapper {
            position: relative;
            width: 100%;
            height: 180px;
            background: #1e293b;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
            border: 1px solid #334155;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #f59e0b; /* Amber 500 */
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        .status-badge {
            transition: all 0.3s ease;
        }
        .status-listening {
            background-color: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
            color: #34d399;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        .status-muted {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }
        
        #threshold-bar {
            position: absolute;
            left: 0;
            top: 0; /* Will be set dynamically */
            bottom: 0;
            width: 2px;
            background-color: rgba(245, 158, 11, 0.8);
            z-index: 10;
            pointer-events: none;
            transition: left 0.1s;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl p-6 border border-slate-700 space-y-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Smooth Echo</h1>
                <p class="text-slate-400 text-xs mt-1">Headphones recommended</p>
            </div>
            <div id="status-badge" class="status-badge text-xs font-mono border px-3 py-1.5 rounded-full bg-slate-900 border-slate-700 text-slate-500">
                OFFLINE
            </div>
        </div>

        <!-- Visualizer Area -->
        <div class="visualizer-wrapper">
            <canvas id="visualizer"></canvas>
            
            <!-- Threshold Line (Visual Guide) -->
            <div id="threshold-line" class="absolute left-0 right-0 border-b border-dashed border-amber-500/50 pointer-events-none transition-all duration-100" style="bottom: 15%">
                <span class="absolute right-2 -top-6 text-[10px] text-amber-500 bg-slate-900/80 px-1 rounded">Activation Level</span>
            </div>

            <!-- Start Overlay -->
            <div id="start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 z-20 backdrop-blur-sm transition-opacity duration-300">
                <div class="p-4 bg-slate-800 rounded-full mb-4 shadow-lg ring-1 ring-slate-700">
                    <i class="fa-solid fa-headphones text-3xl text-blue-400"></i>
                </div>
                <span class="text-slate-200 font-semibold">Tap Start to Begin</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="space-y-6">
            
            <!-- Delay Control -->
            <div>
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Delay</label>
                    <span id="delay-val" class="text-white font-mono font-bold bg-slate-700 px-2 py-0.5 rounded text-xs">2.0s</span>
                </div>
                <input type="range" id="delay-slider" min="0.1" max="5" step="0.1" value="2.0">
            </div>

            <!-- Activation Threshold (Gate) -->
            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-600/50">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs font-bold text-amber-500 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-microphone-lines"></i> Mic Sensitivity
                    </label>
                    <span id="thresh-val" class="text-amber-500 font-mono font-bold text-xs">Auto</span>
                </div>
                <input type="range" id="thresh-slider" min="1" max="50" step="1" value="15">
                <div class="flex justify-between mt-2 text-[10px] text-slate-500">
                    <span>Always On (Risk of Feedback)</span>
                    <span>Loud Voice Only</span>
                </div>
            </div>

            <!-- Main Button -->
            <button id="toggle-btn" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold transition-all shadow-lg hover:shadow-blue-500/20 active:scale-95 flex items-center justify-center gap-3">
                <i class="fa-solid fa-power-off"></i>
                <span id="btn-text">Start System</span>
            </button>
            
            <p id="feedback-msg" class="hidden text-center text-xs text-amber-400 bg-amber-900/20 p-2 rounded border border-amber-900/50">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> If you hear screeching, lower Sensitivity or use headphones.
            </p>

        </div>
    </div>

    <script>
        // -- Configuration --
        const CONFIG = {
            fftSize: 512,
            holdTime: 0.8, // Seconds to keep audio open after speaking stops (Fixes chopping)
            attackTime: 0.05, // Fade in time
            releaseTime: 0.3  // Fade out time
        };

        // -- State --
        let state = {
            isRunning: false,
            audioCtx: null,
            source: null,
            delay: null,
            gate: null,
            analyser: null,
            stream: null,
            lastLoudTime: 0,
            animationId: null,
            threshold: 0.15 // 0.0 to 1.0
        };

        // -- DOM Elements --
        const el = {
            btn: document.getElementById('toggle-btn'),
            btnText: document.getElementById('btn-text'),
            overlay: document.getElementById('start-overlay'),
            status: document.getElementById('status-badge'),
            canvas: document.getElementById('visualizer'),
            threshLine: document.getElementById('threshold-line'),
            feedbackMsg: document.getElementById('feedback-msg'),
            inputs: {
                delay: document.getElementById('delay-slider'),
                thresh: document.getElementById('thresh-slider')
            },
            displays: {
                delay: document.getElementById('delay-val'),
                thresh: document.getElementById('thresh-val')
            }
        };

        const ctx = el.canvas.getContext('2d');
        let width, height;

        // -- Initialization --
        function resize() {
            width = el.canvas.parentElement.clientWidth;
            height = el.canvas.parentElement.clientHeight;
            el.canvas.width = width;
            el.canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // -- Logic --

        el.btn.addEventListener('click', toggleAudio);

        // Update Slider UI
        el.inputs.delay.addEventListener('input', e => {
            el.displays.delay.innerText = e.target.value + 's';
            if(state.delay) state.delay.delayTime.setTargetAtTime(parseFloat(e.target.value), state.audioCtx.currentTime, 0.1);
        });

        el.inputs.thresh.addEventListener('input', e => {
            const val = parseInt(e.target.value);
            state.threshold = val / 100;
            
            // Visual update of the line
            el.threshLine.style.bottom = (val * 1.5) + '%'; // Scale purely for visual
            
            if (val <= 2) {
                el.displays.thresh.innerText = "Always On";
                state.threshold = 0.001; // Effectively zero
            } else {
                el.displays.thresh.innerText = val + "%";
            }
        });

        async function toggleAudio() {
            if (state.isRunning) {
                stop();
            } else {
                await start();
            }
        }

        async function start() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                state.audioCtx = new AudioContext();

                // 1. Get Microphone
                state.stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true, // Attempt to cancel system speaker echo
                        noiseSuppression: true,
                        autoGainControl: false // Disable AGC to prevent volume pumping
                    }
                });

                // 2. Create Nodes
                state.source = state.audioCtx.createMediaStreamSource(state.stream);
                state.analyser = state.audioCtx.createAnalyser();
                state.analyser.fftSize = CONFIG.fftSize;
                state.analyser.smoothingTimeConstant = 0.5;

                state.delay = state.audioCtx.createDelay(10.0);
                state.delay.delayTime.value = parseFloat(el.inputs.delay.value);

                // The Gate is a Gain Node
                state.gate = state.audioCtx.createGain();
                state.gate.gain.value = 0; // Start muted

                // 3. Connect Graph
                // Mic -> Analyser (For visual + Logic)
                state.source.connect(state.analyser);
                
                // Mic -> Gate -> Delay -> Speakers
                state.source.connect(state.gate);
                state.gate.connect(state.delay);
                state.delay.connect(state.audioCtx.destination);

                // UI Updates
                state.isRunning = true;
                el.overlay.style.opacity = '0';
                setTimeout(() => el.overlay.classList.add('hidden'), 300);
                
                el.btn.classList.replace('bg-blue-600', 'bg-red-500');
                el.btn.classList.replace('hover:bg-blue-500', 'hover:bg-red-400');
                el.btnText.innerText = "Stop System";
                el.feedbackMsg.classList.remove('hidden');

                processLoop();

            } catch (err) {
                console.error(err);
                alert("Microphone access failed. Please check permissions.");
            }
        }

        function stop() {
            if (state.stream) state.stream.getTracks().forEach(t => t.stop());
            if (state.audioCtx) state.audioCtx.close();
            if (state.animationId) cancelAnimationFrame(state.animationId);

            state.isRunning = false;
            
            // UI Reset
            el.overlay.classList.remove('hidden');
            // Force reflow
            void el.overlay.offsetWidth; 
            el.overlay.style.opacity = '1';

            el.btn.classList.replace('bg-red-500', 'bg-blue-600');
            el.btn.classList.replace('hover:bg-red-400', 'hover:bg-blue-500');
            el.btnText.innerText = "Start System";
            el.status.className = "status-badge text-xs font-mono border px-3 py-1.5 rounded-full bg-slate-900 border-slate-700 text-slate-500";
            el.status.innerText = "OFFLINE";
            el.feedbackMsg.classList.add('hidden');
            
            ctx.clearRect(0,0,width,height);
        }

        // --- Core Processing Loop ---
        function processLoop() {
            if (!state.isRunning) return;
            state.animationId = requestAnimationFrame(processLoop);

            const bufferLength = state.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            state.analyser.getByteFrequencyData(dataArray);

            // 1. Calculate Average Volume
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
            const avg = sum / bufferLength;
            const normalizedVol = avg / 255; // 0.0 to 1.0 range

            // 2. Logic: Hysteresis / Hold Time
            // This prevents "chopping" by keeping the gate open for a while
            const now = state.audioCtx.currentTime;

            if (normalizedVol > state.threshold) {
                // Sound is loud enough: Open Gate
                state.lastLoudTime = now;
                
                // Smooth Fade In (Attack)
                state.gate.gain.setTargetAtTime(1, now, CONFIG.attackTime);
                
                updateStatus(true);
            } else {
                // Sound is quiet... check hold time
                if (now - state.lastLoudTime < CONFIG.holdTime) {
                    // KEEP OPEN (Holding...)
                    state.gate.gain.setTargetAtTime(1, now, CONFIG.attackTime);
                    updateStatus(true);
                } else {
                    // CLOSE (Release) - Smooth Fade Out
                    state.gate.gain.setTargetAtTime(0, now, CONFIG.releaseTime);
                    updateStatus(false);
                }
            }

            // 3. Draw
            drawVisualizer(dataArray, bufferLength);
        }

        function updateStatus(isOpen) {
            if (isOpen) {
                el.status.className = "status-badge status-listening text-xs font-mono border px-3 py-1.5 rounded-full font-bold";
                el.status.innerText = "LISTENING & ECHOING";
                el.status.style.opacity = "1";
            } else {
                el.status.className = "status-badge status-muted text-xs font-mono border px-3 py-1.5 rounded-full";
                el.status.innerText = "WAITING FOR SOUND";
                el.status.style.opacity = "0.7";
            }
        }

        function drawVisualizer(data, len) {
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, 0, width, height);

            const barWidth = (width / len) * 2.5;
            let x = 0;

            for (let i = 0; i < len; i++) {
                const barHeight = (data[i] / 255) * height;

                // Color logic
                const hue = i + (Date.now() / 50); // Animated rainbow
                ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
                
                // If gate is closed, make bars gray
                if (el.status.innerText.includes("WAITING")) {
                    ctx.fillStyle = '#334155';
                }

                ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

    </script>
</body>
</html>

