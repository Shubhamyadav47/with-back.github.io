<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symphony Sync</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Google Fonts for Classic Look -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #1a1a1a;
            font-family: 'Playfair Display', serif;
        }
        .wood-texture {
            background: 
                repeating-linear-gradient(45deg, #3d2616 0, #3d2616 1px, #523420 1px, #523420 4px),
                repeating-linear-gradient(-45deg, #3d2616 0, #3d2616 1px, #523420 1px, #523420 4px);
            box-shadow: inset 0 0 50px #000;
        }
        .gold-text {
            background: linear-gradient(to bottom, #cfc09f 22%, #634f2c 24%, #cfc09f 26%, #cfc09f 27%, #ffecb3 40%, #3a2c0f 78%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            color: #fff; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .gold-border {
            border: 2px solid #b39b5e;
            box-shadow: 0 0 5px #b39b5e, inset 0 0 5px #b39b5e;
        }
        .vinyl {
            animation: spin 0s linear infinite;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        .vinyl.spinning {
            animation-duration: 4s;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        /* Custom Range Input */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #b39b5e;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- React App ---
        const { useState, useEffect, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // home, host, guest
            const [sessionId, setSessionId] = useState('');
            
            // Auth Initialization
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            if (!user) return (
                <div className="min-h-screen wood-texture flex items-center justify-center text-amber-100">
                    <div className="text-center animate-pulse">
                        <i className="fas fa-compact-disc fa-3x mb-4 text-[#b39b5e]"></i>
                        <h1 className="text-xl font-serif">Initializing Vintage Audio...</h1>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen wood-texture text-amber-50 selection:bg-amber-900 selection:text-white overflow-hidden flex flex-col">
                    <Header />
                    
                    <div className="flex-1 flex items-center justify-center p-4">
                        {view === 'home' && (
                            <HomeView 
                                onHost={() => {
                                    // Generate a random 6-digit session ID
                                    const newId = Math.floor(100000 + Math.random() * 900000).toString();
                                    setSessionId(newId);
                                    setView('host');
                                }}
                                onJoin={(id) => {
                                    setSessionId(id);
                                    setView('guest');
                                }}
                            />
                        )}
                        
                        {(view === 'host' || view === 'guest') && (
                            <Player 
                                role={view} 
                                sessionId={sessionId} 
                                user={user}
                                onLeave={() => setView('home')}
                            />
                        )}
                    </div>
                    
                    <Footer />
                </div>
            );
        }

        // --- Components ---

        const Header = () => (
            <header className="p-6 text-center border-b border-[#523420] bg-black/30 backdrop-blur-sm">
                <h1 className="text-4xl md:text-5xl font-serif tracking-widest gold-text uppercase" style={{fontFamily: 'Cinzel, serif'}}>
                    Symphony Sync
                </h1>
                <p className="text-[#b39b5e] text-xs md:text-sm mt-2 font-serif tracking-widest opacity-80">
                    High Fidelity Networked Audio
                </p>
            </header>
        );

        const Footer = () => (
            <footer className="p-4 text-center text-[#523420] text-xs font-serif">
                Establish Connection • Upload Media • Synchronize
            </footer>
        );

        const HomeView = ({ onHost, onJoin }) => {
            const [joinId, setJoinId] = useState('');

            return (
                <div className="glass-panel p-8 md:p-12 rounded-lg shadow-2xl max-w-lg w-full text-center border-t-4 border-t-[#b39b5e]">
                    <h2 className="text-2xl font-serif mb-8 text-[#e0d0b0]">Select Mode</h2>
                    
                    <div className="space-y-6">
                        <button 
                            onClick={onHost}
                            className="w-full group relative py-4 px-6 border border-[#b39b5e] rounded hover:bg-[#b39b5e]/10 transition-all duration-300"
                        >
                            <div className="flex items-center justify-between">
                                <span className="text-xl font-serif text-[#b39b5e] group-hover:text-white transition-colors">Start Broadcast (Host)</span>
                                <i className="fas fa-broadcast-tower text-[#b39b5e]"></i>
                            </div>
                            <p className="text-left text-xs text-gray-400 mt-2">Create a room and control the music for everyone.</p>
                        </button>

                        <div className="relative flex py-2 items-center">
                            <div className="flex-grow border-t border-[#523420]"></div>
                            <span className="flex-shrink mx-4 text-gray-500 font-serif italic">or</span>
                            <div className="flex-grow border-t border-[#523420]"></div>
                        </div>

                        <div className="space-y-3">
                            <input 
                                type="number" 
                                value={joinId}
                                onChange={(e) => setJoinId(e.target.value)}
                                placeholder="Enter 6-Digit Frequency Code"
                                className="w-full bg-black/50 border border-[#523420] p-4 text-center text-[#b39b5e] tracking-[0.5em] text-lg rounded focus:outline-none focus:border-[#b39b5e]"
                            />
                            <button 
                                onClick={() => joinId.length >= 4 && onJoin(joinId)}
                                disabled={joinId.length < 4}
                                className="w-full bg-[#b39b5e] text-black font-bold py-3 px-6 rounded hover:bg-[#cfc09f] transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-serif uppercase tracking-wider"
                            >
                                Tune In
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Player = ({ role, sessionId, user, onLeave }) => {
            // Player Logic State
            const [status, setStatus] = useState('Connecting...');
            const [isPlaying, setIsPlaying] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            
            // Media State
            const [audioSrc, setAudioSrc] = useState(null);
            const [trackName, setTrackName] = useState('No Record Loaded');
            const [hostFilename, setHostFilename] = useState('');
            const [isLocalFile, setIsLocalFile] = useState(false);
            
            // Refs
            const audioRef = useRef(null);
            const dbRef = useRef(null);
            const isSeeking = useRef(false);
            const lastSyncTime = useRef(0);

            // 1. Initialize Firestore Listener
            useEffect(() => {
                if (!sessionId || !user) return;

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', `music-session-${sessionId}`);
                dbRef.current = docRef;

                // Host initializes the session
                if (role === 'host') {
                    setDoc(docRef, {
                        hostId: user.uid,
                        status: 'paused',
                        currentTime: 0,
                        timestamp: serverTimestamp(),
                        trackName: 'Waiting for Host...',
                        sourceType: 'none', // 'url' or 'local'
                        sourceUrl: ''
                    }, { merge: true });
                }

                // Both listen for changes
                const unsubscribe = onSnapshot(docRef, (snap) => {
                    if (!snap.exists()) {
                        setStatus('Channel Closed');
                        return;
                    }
                    const data = snap.data();
                    handleSync(data);
                });

                return () => unsubscribe();
            }, [sessionId, user, role]);

            // 2. Synchronization Logic
            const handleSync = (data) => {
                const audio = audioRef.current;
                if (!audio) return;

                // Meta Sync
                if (role === 'guest') {
                    if (data.trackName !== trackName) {
                        setTrackName(data.trackName);
                        setHostFilename(data.trackName);
                        // If it's a URL, auto-load it
                        if (data.sourceType === 'url' && data.sourceUrl !== audioSrc) {
                            setAudioSrc(data.sourceUrl);
                            setIsLocalFile(false);
                            setStatus('Recieving Signal...');
                        } else if (data.sourceType === 'local') {
                            setIsLocalFile(true);
                            if (!audioSrc) setStatus('Load Matching File');
                        }
                    }
                }

                // Playback Sync
                const now = Date.now();
                // Prevent jitter by ignoring updates that are too close (unless it's a pause event)
                if (now - lastSyncTime.current < 500 && data.status === 'playing') return;
                lastSyncTime.current = now;

                if (data.status === 'playing') {
                    // Calculate latency compensated time
                    // Firestore timestamp to millis
                    const serverTime = data.timestamp ? data.timestamp.toMillis() : Date.now();
                    const latency = (Date.now() - serverTime) / 1000;
                    const targetTime = data.currentTime + latency;

                    // Sync if drift is > 0.3s
                    if (Math.abs(audio.currentTime - targetTime) > 0.3) {
                         // Only sync time if we have media loaded
                         if (audio.duration) {
                             audio.currentTime = targetTime;
                         }
                    }
                    
                    if (audio.paused && audio.src) {
                        audio.play().catch(e => {
                            console.log("Autoplay blocked, waiting for user interaction");
                            setStatus("Click Play to Sync");
                        });
                    }
                    setIsPlaying(true);
                    setStatus(role === 'host' ? 'Broadcasting' : 'Synced');
                } else {
                    if (!audio.paused) audio.pause();
                    setIsPlaying(false);
                    setStatus('Paused');
                }
            };

            // 3. Host Controls
            const updateRemoteState = async (playing, time) => {
                if (role !== 'host' || !dbRef.current) return;
                
                await updateDoc(dbRef.current, {
                    status: playing ? 'playing' : 'paused',
                    currentTime: time,
                    timestamp: serverTimestamp()
                });
            };

            // 4. Event Handlers
            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setAudioSrc(url);
                    setTrackName(file.name.replace(/\.[^/.]+$/, ""));
                    setIsLocalFile(true);
                    
                    // Reset remote
                    if (role === 'host') {
                         updateDoc(dbRef.current, {
                            trackName: file.name.replace(/\.[^/.]+$/, ""),
                            sourceType: 'local',
                            sourceUrl: '', // Can't upload file, so empty
                            currentTime: 0,
                            status: 'paused'
                        });
                    }
                }
            };

            const handleUrlInput = (e) => {
                if (e.key === 'Enter') {
                    const url = e.target.value;
                    if (url) {
                        setAudioSrc(url);
                        setTrackName("Network Stream");
                        setIsLocalFile(false);
                        if (role === 'host') {
                            updateDoc(dbRef.current, {
                                trackName: "Network Stream",
                                sourceType: 'url',
                                sourceUrl: url,
                                currentTime: 0,
                                status: 'paused'
                            });
                        }
                    }
                }
            };

            const togglePlay = () => {
                const audio = audioRef.current;
                if (!audio) return;

                if (role === 'host') {
                    if (isPlaying) {
                        audio.pause();
                        updateRemoteState(false, audio.currentTime);
                    } else {
                        audio.play();
                        updateRemoteState(true, audio.currentTime);
                    }
                } else {
                    // Guest override to enable audio context
                    if (audio.paused) audio.play();
                    else audio.pause();
                }
            };

            const handleSeek = (e) => {
                const time = parseFloat(e.target.value);
                setProgress(time);
                audioRef.current.currentTime = time;
                
                if (role === 'host') {
                    updateRemoteState(isPlaying, time);
                }
            };

            // Time Update Loop (Visual Only)
            const onTimeUpdate = () => {
                if (!isSeeking.current && audioRef.current) {
                    setProgress(audioRef.current.currentTime);
                    if (role === 'host' && isPlaying && Math.floor(audioRef.current.currentTime) % 5 === 0) {
                        // Periodic sync pulse from host every 5s to keep drift low
                        updateRemoteState(true, audioRef.current.currentTime);
                    }
                }
            };

            return (
                <div className="w-full max-w-4xl flex flex-col items-center">
                    
                    {/* Status Bar */}
                    <div className="w-full flex justify-between items-center mb-6 px-4">
                        <div className="flex items-center gap-2">
                            <div className={`w-3 h-3 rounded-full ${isPlaying ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                            <span className="text-xs tracking-widest uppercase font-serif text-[#b39b5e]">{status}</span>
                        </div>
                        <div className="text-[#b39b5e] font-serif border border-[#b39b5e] px-3 py-1 rounded text-sm">
                            FREQ: <span className="font-bold text-white tracking-widest">{sessionId}</span>
                        </div>
                        <button onClick={onLeave} className="text-xs text-red-400 hover:text-red-300 font-serif uppercase">
                            Disconnect
                        </button>
                    </div>

                    {/* Main Player Deck */}
                    <div className="relative w-full glass-panel rounded-xl p-6 md:p-10 gold-border overflow-hidden flex flex-col md:flex-row gap-8 items-center">
                        
                        {/* Left: Vinyl */}
                        <div className="relative flex-shrink-0">
                            <div className={`w-64 h-64 md:w-80 md:h-80 rounded-full bg-black border-4 border-[#1a1a1a] relative flex 