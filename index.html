<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Audio Echo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .visualizer-container {
            position: relative;
            width: 100%;
            height: 160px;
            background: #1e293b;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #60a5fa;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        .gate-active {
            color: #ef4444; /* Red for closed gate */
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }
        .gate-open {
            color: #22c55e; /* Green for open gate */
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.4);
        }
        
        /* Threshold Marker on Visualizer */
        #threshold-line {
            position: absolute;
            left: 0;
            right: 0;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.2);
            pointer-events: none;
            transition: bottom 0.1s;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl p-6 border border-slate-700 space-y-5">
        
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-white">Smart Echo</h1>
                <p class="text-slate-400 text-xs mt-1">Prevents feedback loops automatically</p>
            </div>
            <div id="gate-indicator" class="text-xs font-mono border border-slate-600 px-2 py-1 rounded bg-slate-900 text-slate-500">
                GATE CLOSED
            </div>
        </div>

        <!-- Visualizer -->
        <div class="visualizer-container ring-1 ring-slate-600/50 relative">
            <canvas id="visualizer"></canvas>
            <div id="threshold-line" style="bottom: 10%;"></div>
            <div id="status-overlay" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 transition-opacity duration-300">
                <span class="text-slate-300 font-medium tracking-wide">Press Start</span>
            </div>
        </div>

        <!-- Controls Container -->
        <div class="space-y-5">
            
            <!-- Delay Control -->
            <div class="control-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Delay Time</label>
                    <span id="delay-display" class="text-blue-400 font-mono text-sm">2.0s</span>
                </div>
                <input type="range" id="delay-slider" min="0.1" max="5" step="0.1" value="2.0">
            </div>

            <!-- Noise Gate Threshold (The Fix) -->
            <div class="control-group bg-slate-700/50 p-3 rounded-lg border border-slate-600/50">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-filter text-emerald-400"></i> Mic Threshold
                    </label>
                    <span id="gate-display" class="text-emerald-400 font-mono text-sm">10%</span>
                </div>
                <input type="range" id="gate-slider" min="0" max="50" step="1" value="10">
                <p class="text-[10px] text-slate-400 mt-2 leading-tight">
                    *Audio only plays when sound is louder than this line. Increase this if you hear feedback/echos.
                </p>
            </div>

            <!-- Output Volume -->
            <div class="control-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Output Volume</label>
                    <span id="volume-display" class="text-purple-400 font-mono text-sm">80%</span>
                </div>
                <input type="range" id="volume-slider" min="0" max="100" step="1" value="80">
            </div>

            <!-- Main Action Button -->
            <button id="toggle-btn" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold transition-all shadow-lg hover:shadow-blue-500/20 flex items-center justify-center gap-2">
                <i class="fa-solid fa-microphone"></i>
                <span id="btn-text">Start Echo</span>
            </button>
            
            <div id="error-msg" class="hidden p-3 bg-red-900/50 border border-red-500/30 rounded text-red-200 text-xs text-center"></div>

        </div>
    </div>

    <script>
        // DOM Elements
        const toggleBtn = document.getElementById('toggle-btn');
        const btnText = document.getElementById('btn-text');
        const canvas = document.getElementById('visualizer');
        const statusOverlay = document.getElementById('status-overlay');
        const errorMsg = document.getElementById('error-msg');
        const gateIndicator = document.getElementById('gate-indicator');
        const thresholdLine = document.getElementById('threshold-line');

        // Sliders & Displays
        const delaySlider = document.getElementById('delay-slider');
        const delayDisplay = document.getElementById('delay-display');
        const gateSlider = document.getElementById('gate-slider');
        const gateDisplay = document.getElementById('gate-display');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');

        // Audio Variables
        let audioCtx;
        let mediaStream;
        let sourceNode;
        let delayNode;
        let analyser;
        let outputGainNode;
        let gateNode; // We'll use a GainNode as a gate
        let animationId;
        let isRunning = false;
        
        // Gate Logic Variables
        let gateThreshold = 0.1; // 0 to 1 scale (based on 0-255 byte data)
        let currentVolume = 0;
        let isGateOpen = false;

        // Canvas Setup
        const canvasCtx = canvas.getContext('2d');
        let canvasWidth = canvas.parentElement.clientWidth;
        let canvasHeight = canvas.parentElement.clientHeight;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        window.addEventListener('resize', () => {
            canvasWidth = canvas.parentElement.clientWidth;
            canvasHeight = canvas.parentElement.clientHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        });

        // --- Event Listeners ---

        delaySlider.addEventListener('input', (e) => {
            const val = e.target.value;
            delayDisplay.innerText = `${val}s`;
            if (delayNode) delayNode.delayTime.setTargetAtTime(val, audioCtx.currentTime, 0.1);
        });

        gateSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            gateDisplay.innerText = `${val}%`;
            gateThreshold = val / 100; // Convert 0-50 to 0.0-0.5
            // Update visual line height
            thresholdLine.style.bottom = `${val}%`; // Scale for visual (rough approx)
        });

        volumeSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            volumeDisplay.innerText = `${val}%`;
            if (outputGainNode) outputGainNode.gain.setTargetAtTime(val / 100, audioCtx.currentTime, 0.05);
        });

        toggleBtn.addEventListener('click', async () => {
            if (isRunning) stopAudio();
            else await startAudio();
        });

        // --- Audio Logic ---

        async function startAudio() {
            try {
                errorMsg.classList.add('hidden');
                
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();

                // 1. Get Mic with Echo Cancellation ENABLED
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true, // Crucial for preventing feedback
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });

                // 2. Create Nodes
                sourceNode = audioCtx.createMediaStreamSource(mediaStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; // Smaller FFT for faster reaction
                analyser.smoothingTimeConstant = 0.3;

                delayNode = audioCtx.createDelay(10.0);
                delayNode.delayTime.value = parseFloat(delaySlider.value);

                // The Gate Node blocks sound going to the delay line
                gateNode = audioCtx.createGain();
                gateNode.gain.value = 0; // Start closed (silence)

                outputGainNode = audioCtx.createGain();
                outputGainNode.gain.value = parseFloat(volumeSlider.value) / 100;

                // 3. Connect Graph
                // Mic -> Analyser (to measure volume)
                sourceNode.connect(analyser);

                // Mic -> Gate -> Delay -> OutputGain -> Speaker
                sourceNode.connect(gateNode);
                gateNode.connect(delayNode);
                delayNode.connect(outputGainNode);
                outputGainNode.connect(audioCtx.destination);

                isRunning = true;
                updateUI(true);
                processAudioLoop();

            } catch (err) {
                console.error(err);
                showError("Could not access microphone. Please ensure you have granted permission.");
            }
        }

        function stopAudio() {
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            if (audioCtx) audioCtx.close();
            if (animationId) cancelAnimationFrame(animationId);
            
            isRunning = false;
            updateUI(false);
            
            // Reset Gate UI
            gateIndicator.className = "text-xs font-mono border border-slate-600 px-2 py-1 rounded bg-slate-900 text-slate-500";
            gateIndicator.innerText = "GATE CLOSED";
        }

        // --- Processing Loop (Visuals + Noise Gate) ---
        function processAudioLoop() {
            if (!isRunning) return;
            animationId = requestAnimationFrame(processAudioLoop);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // 1. Calculate Average Volume
            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;
            const normalizedVol = average / 255; // 0.0 to 1.0

            // 2. Noise Gate Logic
            // If volume > threshold, Open Gate. Else, Close Gate.
            // Using setTargetAtTime for smooth envelope (no clicking)
            if (normalizedVol > gateThreshold) {
                // Open Gate (Allow sound)
                if(!isGateOpen) {
                    gateNode.gain.setTargetAtTime(1, audioCtx.currentTime, 0.01); // Fast attack
                    isGateOpen = true;
                    updateGateUI(true);
                }
            } else {
                // Close Gate (Mute sound)
                if(isGateOpen) {
                    // Slight release time to not cut off words abruptly
                    gateNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2); 
                    isGateOpen = false;
                    updateGateUI(false);
                }
            }

            // 3. Draw Visualizer
            drawVisuals(dataArray, bufferLength);
        }

        function drawVisuals(dataArray, bufferLength) {
            canvasCtx.fillStyle = '#1e293b';
            canvasCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            const barWidth = (canvasWidth / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = (dataArray[i] / 255) * canvasHeight;

                // Color based on Gate Status
                if(isGateOpen) {
                     canvasCtx.fillStyle = `rgb(${barHeight + 50}, 255, 100)`;
                } else {
                     canvasCtx.fillStyle = `rgb(100, 116, 139)`; // Slate-500 (muted)
                }

                canvasCtx.fillRect(x, canvasHeight - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        // --- UI Helpers ---

        function updateUI(active) {
            if (active) {
                toggleBtn.classList.replace('bg-blue-600', 'bg-red-600');
                toggleBtn.classList.replace('hover:bg-blue-500', 'hover:bg-red-500');
                toggleBtn.querySelector('i').className = "fa-solid fa-stop";
                btnText.innerText = "Stop";
                statusOverlay.style.opacity = '0';
            } else {
                toggleBtn.classList.replace('bg-red-600', 'bg-blue-600');
                toggleBtn.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');
                toggleBtn.querySelector('i').className = "fa-solid fa-microphone";
                btnText.innerText = "Start Echo";
                statusOverlay.style.opacity = '1';
                
                // Clear Canvas
                canvasCtx.clearRect(0,0, canvasWidth, canvasHeight);
            }
        }

        function updateGateUI(isOpen) {
            if(isOpen) {
                gateIndicator.className = "text-xs font-mono border border-green-500/50 px-2 py-1 rounded bg-green-900/20 gate-open font-bold shadow-[0_0_10px_rgba(34,197,94,0.2)]";
                gateIndicator.innerText = "TRANSMITTING";
            } else {
                gateIndicator.className = "text-xs font-mono border border-red-500/30 px-2 py-1 rounded bg-red-900/10 gate-active";
                gateIndicator.innerText = "GATE CLOSED";
            }
        }

        function showError(msg) {
            errorMsg.innerText = msg;
            errorMsg.classList.remove('hidden');
        }
    </script>
</body>
</html>

